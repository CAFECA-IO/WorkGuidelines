# **試算表 Debug SOP**

本 SOP 旨在協助後端開發人員高效定位並修復試算表相關問題，包括建立測試環境、問題分析、數據驗證、日誌埋設與修正指引等。  

---

## **1. 建立測試資料**

在進行 Debug 前，需建立標準化的測試資料，確保測試的穩定性和可復現性。

### **1.1 測試資料要求**
- **Company ID**: `10000007`
- **User ID**: `10000006`（具存取權限）
- **Role ID**: `1003`
- **Voucher 總數**: 18 張
  - 借方：1,313,296
  - 貸方：1,313,296

### **1.2 測試資料生成**
使用以下步驟生成測試資料：
1. 確保資料庫已準備好測試環境。
2. 若測試資料庫為空，請執行以下指令重置並初始化 Seed 資料：
   ```bash
   npx prisma migrate reset
   ```
3. 若需指定數據（例如 Voucher），請使用專用 Seed 檔案。

---

## **2. 設置測試環境**

測試環境應模擬實際情境，確保操作時 Session 資訊準確且可切換。

### **2.1 修改 Session 設定**
在 `src/utils/session.ts` 中新增測試環境切換邏輯，並使用環境變數控制：

```typescript
const TEST_MODE = process.env.TEST_MODE === 'true';

export const getSession = () => {
  if (TEST_MODE) {
    return {
      userId: 10000006,
      companyId: 10000007,
      challenge: 'challenge',
      roleId: 1003,
    };
  }
  // 正式環境 Session 邏輯
  return nextSession(options);
};
```

**注意：**
- 開發完成後，務必將 `TEST_MODE` 設為 `false`，避免影響其他環境。

---

## **3. 確認相關 API 測試結果**

### **3.1 試算表 API**
測試 API：
```http
http://localhost:3000/api/v2/company/10000007/trial_balance?startDate=1734710400&endDate=1734796799&page=1&pageSize=99999
```

**期望結果**：
- 借方：`1,313,296`
- 貸方：`1,313,296`

**異常結果**：
- 借方：`1,313,186`
- 貸方：`1,313,186`

**問題分析**：
- 科目 `10001469` 借方 100 + 10、貸方 100 + 10，因科目刪除導致數據缺漏。

**修正建議**：
1. 修改邏輯，即使科目刪除，仍列出數據。
2. 使用科目 ID (`10001469`) 作為代稱。

---

### **3.2 總分類帳 API**
測試 API：
```http
http://localhost:3000/api/v2/company/10000007/ledger?startDate=1704038400&endDate=1734796799&startAccountNo=&endAccountNo=&labelType=general&pageSize=99999
```

**期望結果**：
- 借方與貸方金額一致。

**異常結果**：
- 借方：`496,985`
- 貸方：`1,369,819`

**問題分析**：
- 借方少了 `816,201`，貸方多了 `56,633`。

**修正建議**：
進一步檢查輸入資料是否完整、程式邏輯是否正確，並對應資料進行比對。

---

## **4. 嘗試分析並還原數據**

針對問題科目進行數據還原，確認數據是否正確記錄。

### **4.1 科目還原**
檢查科目 `10001469` 的數據：
1. LineItem 借方 (`debit`) 金額：`100`
2. LineItem 貸方 (`credit`) 金額：`110`
3. 若科目刪除，應使用 ID 作為代稱顯示在報表中。

### **4.2 日誌記錄**
在數據分析過程中埋設日誌，檢查數據流是否正常。

---

## **5. 埋設日誌進行 Debug**

日誌是定位問題的核心工具，應記錄完整上下文資訊。

### **5.1 日誌格式**
統一使用以下格式：
```typescript
loggerBack.info({
  module: 'TrialBalance',
  step: 'initializeAccountBook',
  voucherId: voucher.id,
  lineItems: voucher.lineItems,
  message: 'Check Voucher consistency',
});
```

### **5.2 檢查重點**
1. **Voucher 數量檢查**：
   - 初始化後應有 47 筆，但僅匯入 42 筆。
   - 缺失的 5 筆為科目 `10001469`。

2. **科目數據檢查**：
   - 檢查每個科目的借貸加總，特別是異常科目。

3. **加總結果檢查**：
   - 確保試算表中的借貸加總一致，並記錄不一致的數據與原因。

---

## **6. 修正與驗證**

### **6.1 修正問題**
根據分析結果，實施以下修正：
1. 修改查詢邏輯，確保刪除的科目也能被列出。
2. 優化數據加總的處理方式，確保試算表和總分類帳一致。

### **6.2 重新測試**
修正完成後，重新執行以下測試：
1. 試算表 API：確認借貸金額一致。
2. 總分類帳 API：確認每個科目金額正確。

---

## **7. 提交結果與總結**

1. 紀錄測試過程與修正方案。
2. 將測試結果和修正方案同步至團隊，更新到專案文檔中（如 WIKI）。
3. 確保修正邏輯通過完整的自動化測試。
